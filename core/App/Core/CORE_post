#!/bin/bash

if [ "$dbpsql" == "" ]; then
  . /etc/freedom.conf
   wchoose -b
fi

. $wpub/log.sh
. $wpub/libutil.sh

if [ -z "$pgservice_core" ]; then
    echo "Env variable pgservice_core is empty !"
    echo "Check your freedom environment for missing or misconfigured environment."
    exit 1
fi

#------------------------------
#post installation
#------------------------------
if [ "$1" = "I" ] ; then

    log "Checking if the database service $pgservice_core is running and available..."
    PGSERVICE=$pgservice_core pgIsRunning
    RET=$?
    if [ $RET -ne 0 ]; then
	echo "Could not connect to database service $pgservice_core) !"
	echo "Check that your database is running and acessible with the service from pgservice.conf."
	exit $RET
    fi

    log "Checking if plpsgql language is active on database service $pgservice_core..."
    PGSERVICE=$pgservice_core pgLanguageExists "plpgsql"
    RET=$?
    if [ $RET -ne 0 ]; then
	echo "Could not find language plpgsql on database service $pgservice_core !"
	echo "Check that the plpgsql language is correctly enabled on your database service."
	exit $RET
    fi

    log "Executing $wpub/WHAT/getprivilege.sql in database service $pgservice_core..."
    PGSERVICE=$pgservice_core pgExecuteSqlFile $wpub/WHAT/getprivilege.sql
    RET=$?
    if [ $RET -ne 0 ]; then
	echo "An error occured while executing $wpub/WHAT/getprivilege.sql : $RET"
	exit $RET
    fi

    log "Checking if DateStyle is 'SQL, DMY'..."
    DATESTYLE=`PGSERVICE="$pgservice_core" psql -At -c "SHOW DateStyle" 2> /dev/null`
    RET=$?
    if [ $RET -ne 0 ]; then
	echo "An error occured while querying DateStyle : $RET"
	exit $RET
    fi
    if [ "$DATESTYLE" != "SQL, DMY" ]; then
	echo "Error: DateStyle is not 'SQL, DMY' on database service $pgservice_core !"
	echo "Please fix it."
	exit 1
    fi

    log "Register DB $dbname for automatic dump..."
    ll=0
    if [ -f /etc/ankpsql-tools/base-list ] ; then
	ll=`cat /etc/ankpsql-tools/base-list | grep "^$dbname$" | wc -l`
    fi
    if [ $ll -eq 0 ]; then 
	echo "Register DB $dbname for automatic dump"
	echo "$dbname" >> /etc/ankpsql-tools/base-list
    fi
    
    # Add logrotate
    echo "/var/log/what.log {"               >  /etc/logrotate.d/what
    echo "   missingok"                      >> /etc/logrotate.d/what
    echo "   postrotate"                     >> /etc/logrotate.d/what
    echo "   /usr/bin/killall -HUP syslog-ng"  >> /etc/logrotate.d/what
    echo "   endscript"                      >> /etc/logrotate.d/what
    echo "}"                                 >> /etc/logrotate.d/what
    
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Application
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Action
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Style
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=ParamDef
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Param
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=User
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Group
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Permission
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Acl
    /usr/bin/php -q $wpub/API/updateclass.php --dbcoord="service='$pgservice_core'" --class=Session
    $wpub/wsh.php  --api=appadmin
fi


#------------------------------
#post update
#------------------------------
if [ "$1" = "U" ] ; then

    #add permission functionnalities
    log "Executing $wpub/WHAT/getprivilege.sql in database service $pgservice_core..."
    PGSERVICE=$pgservice_core pgExecuteSqlFile $wpub/WHAT/getprivilege.sql
    RET=$?
    if [ $RET -ne 0 ]; then
	echo "An error occured while executing $wpub/WHAT/getprivilege.sql : $RET"
	exit $RET
    fi

    $wpub/wsh.php  --api=import_size 
    $wpub/wsh.php  --api=import_style --name=DEFAULT
    $wpub/wsh.php  --api=import_style --name=ORIGINAL
    echo 'delete from permission where abs(id_acl) not in (select id from acl where acl.id_application=permission.id_application)' | PGSERVICE=$pgservice_core psql $dbpsql
fi

#------------------------------
#post uninstallation
#------------------------------
if [ "$1" = "D" ] ; then

  set -e

  grep -v 'Include %{destdir}/apache.conf' /etc/httpd/conf/httpd.conf > /tmp/httpd.conf
  mv /tmp/httpd.conf /etc/httpd/conf/httpd.conf

  # Remove what from syslog
  echo "Remove what.log from syslog"
  cp /etc/syslog.conf /etc/syslog.conf.sav
  cat /etc/syslog.conf.sav | grep -v "^local6.*/var/log/what.log.*$" > /etc/syslog.conf
  /etc/rc.d/init.d/syslog restart
  rm -f /etc/logrotate.d/what

  # drop anakeen database and user
  log "The $dbname database will be dropped, we save a dump in /tmp/anakeen$$.dump"
  sulog  postgres  "pg_dump -d $dbname >/tmp/anakeen$$.dump"
  sulog  postgres  "dropuser anakeen" 
  sulog  postgres  "dropdb $dbname"

  log "Unregister DB $dbname for automatic dump"
  mv /etc/ankpsql-tools/base-list /etc/ankpsql-tools/base-list.old
  cat /etc/ankpsql-tools/base-list.old | grep -v "^$dbname$" > /etc/ankpsql-tools/base-list
  rm -f /etc/ankpsql-tools/base-list.old
fi

exit 0
