#! /:/bin/rpm
#
#  File: libwhat.spec
#  $Id: WHAT.spec.in,v 1.63 2006/02/05 09:48:26 marc Exp $
#
#  This is the SPEC file for the What CORE
#  Anakeen What Application
# Conditional build
#  _with_cerbere2       - make rpm for cerbere 2.0
#

%define destdir @prefix@
%define apacheconfdir @APACHECONFDIR@
%define cerbere		%(rpm -q --queryformat '%{VENDOR}' rpm |grep -q 'none' && echo 1 || echo 0)
%if %{cerbere}
%define destdir /home/httpd/what
%define apacheconfdir /etc/httpd/httpd.conf
%define httpuser http
%else
%define destdir /usr/share/what
%define apacheconfdir /etc/httpd/conf.d
%define httpuser apache
%endif
Summary: What Hosting Application Toolkit
Name: @PACKAGE@
Version: @VERSION@
%if %{cerbere}
Release: @RELEASE@
%else
Release: @RELEASE@fc
%endif
License: GPL
Group: Applications/Web
Source: ftp://ftp.souillac.anakeen.com/pub/anakeen/%{name}-%{version}.tar.gz
# post-2.2.0 fix (can go away with next release):
Vendor: Anakeen           
URL: http://www.anakeen.com/
Packager: Yannick Le Briquer <yannick.lebriquer@anakeen.com>
BuildArchitectures: noarch
BuildRoot: %{_tmppath}/%{name}-%{version}-root-%(id -u -n)
Conflicts: AUTHENT USERS CORE APPMNG ACCESS libwhat libjs
Conflicts: MAIL < 0.5.1
Conflicts: FREEDOM < 2.0.0
#BuildRequires: docbook-dtd41-sgml
#BuildRequires: docbook-utils
%if %{cerbere}
BuildRequires: apache-devel
%endif
Requires: php >= 5.0
%if %{cerbere}
Requires: apache >= 2.0
%else
Requires: httpd >= 2.0
%endif
Requires: postgresql >= 7.2
%if %{cerbere}
Requires: postgresql-module-plpgsql
%else
Requires: postgresql-pl
%endif
Requires: php-pgsql
%if %{cerbere}
Requires: php-gettext
Requires: php-pcre
Requires: php-cgi
Requires: php-mhash
Requires: php-mcrypt
%endif
Requires: php-ncurses
%if %{cerbere}
Requires: apache-mod_auth
Requires: apache-mod_dir
Requires: apache-mod_expires
%endif
Requires: apache-mod_auth_pam 
Requires: pam_what >= 0.4.0
Requires: ankpsql-tools
Requires: gettext
%if %{cerbere}
Requires: gettext-devel > 0.11
Requires: php-pear-PEAR
%endif
Requires: php-pear-Crypt_CHAP >= 1.0.0
Requires: php-pear

%if %{cerbere}
Prereq: apache
%else
Prereq: httpd
%endif
Prereq: grep
Prereq: SysVinit
Prereq: sudo
Conflicts: FREEDOM-USERCARD < 0.4.0
%if %{cerbere}
Conflicts: libuser < 2.2.3
%endif

%description
The WHAT application toolkit gives common interface element to develop web applications


%prep
%setup -q -n %{name}-%{version}

%build

%install
autoconf
./configure --with-pubrule=`pwd` \
	    --with-httpuser=%{httpuser} \
	    --with-apacheconfdir=%{apacheconfdir} \
	    --prefix=%{destdir}
make -i pubdir=$RPM_BUILD_ROOT%{destdir} 
install -d $RPM_BUILD_ROOT%{apacheconfdir}
install $RPM_BUILD_ROOT/%{destdir}/apache.conf $RPM_BUILD_ROOT/%{apacheconfdir}/71_mod_what.conf

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%post

if [ "$1" = 1 ] ; then
 if [ -f %{destdir}/index.php ]; then
    /bin/rm %{destdir}/index.php
 fi
 /bin/ln -s %{destdir}/admin/winit.html %{destdir}/admin/index.html
  # Restart Apache if running
  if [ -f /var/lock/subsys/httpd ]; then
	/etc/rc.d/init.d/httpd restart 1>&2
  fi
  htpasswd -cb %{destdir}/admin/.htpasswd admin admin
else   

  # just update
  
  chown -R %{httpuser}: %{destdir} 
  if [ ! -f %{destdir}/admin/.htpasswd ]; then
	htpasswd -cb %{destdir}/admin/.htpasswd admin admin
  fi
  
fi
sed -i '/shttpd/d' /etc/sudoers
echo "%{httpuser} ALL=NOPASSWD:%{destdir}/admin/shttpd" >> /etc/sudoers
if [ ! -f %{destdir}/admin/index.html ]; then
       cd %{destdir}/admin
       ln -s %{destdir}/admin/winit.html index.html
       cd - > /dev/null
fi


%{destdir}/wstop


%preun


%postun

  if [ "$1" = 0 ] ; then 

    for fbash in  ~/.bashrc ~/.bash_profile; do
	ll=0
	if [ -f $fbash ] ; then
	    grep -v "winitrc" $fbash > $fbash.tmp
	    mv $fbash.tmp $fbash
	fi    
    done
    sed -i '/shttpd/d' /etc/sudoers

    # Restart Apache if running
    if [ -f /var/lock/subsys/httpd ]; then
	/etc/rc.d/init.d/httpd restart 1>&2
    fi
  fi


%files
%defattr(-,%{httpuser},%{httpuser})
%dir %{destdir}
%doc ChangeLog
%dir %{destdir}/ACCESS
%dir %{destdir}/API
%dir %{destdir}/APPMNG
%dir %{destdir}/AUTHENT
%dir %{destdir}/STYLE
%dir %{destdir}/USERS
%dir %{destdir}/CORE
%dir %{destdir}/WHAT
%dir %{destdir}/expire

%{destdir}/ACCESS/*
%{destdir}/API/*
%{destdir}/APPMNG/*
%{destdir}/AUTHENT/*
%{destdir}/STYLE/*
%{destdir}/USERS/*
%{destdir}/CORE/*
%{destdir}/WHAT/*
%{destdir}/expire/*
%{destdir}/admin/*

%{destdir}/apache.conf
%{destdir}/guest.php
%{destdir}/authent.php
%{destdir}/locale
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wcheck
%attr(755,%{httpuser},%{httpuser}) %{destdir}/whattext
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wsh.php
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wstop
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wstart
%{destdir}/log.sh 
%{destdir}/apachev.conf.in
%{destdir}/apachevi.conf.in
%{destdir}/httpd.pam.in
%{destdir}/httpdwa.pam.in
%{destdir}/wchoose.php
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wdbcreate
%{destdir}/winitrc
%{destdir}/wvirtual.php

%{destdir}/dbaccess.php.in
%{destdir}/dbaccess.sh.in
%config(noreplace) %{destdir}/dbaccess.php
%config(noreplace) %{destdir}/dbaccess.sh

%defattr(-,root,root)
%config(noreplace) /etc/pam.d/httpd
%config(noreplace) /etc/pam.d/httpdwa
%config /etc/freedom.conf
/etc/cron.daily/*
%attr(640,root,root) %config(noreplace) %verify(not size mtime md5) /%{apacheconfdir}/*_mod_*.conf

%changelog
* Tue Oct 30 2000 Yannick Le Briquer <yannick.lebriquer@anakeen.com>
- Build first RPM

