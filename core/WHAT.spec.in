#! /:/bin/rpm
#
#  File: libwhat.spec
#  $Id: WHAT.spec.in,v 1.42 2005/06/10 13:05:18 eric Exp $
#
#  This is the SPEC file for the What CORE
#  Anakeen What Application
# Conditional build
#  _with_cerbere2       - make rpm for cerbere 2.0
#

%define apachedir /etc/httpd
%define destdir /home/httpd/what
%define	_apache2	%(rpm -q apache-devel 2> /dev/null | grep -Eq '\\-2\\.[0-9]+\\.' && echo 1 || echo 0)
Summary: What Hosting Application Toolkit
Name: @PACKAGE@
Version: @VERSION@
Release: @RELEASE@
Copyright: GPL
Group: Applications/Web
Source: ftp://ftp.souillac.anakeen.com/pub/anakeen/%{name}-%{version}.tar.gz
# post-2.2.0 fix (can go away with next release):
Vendor: Anakeen           
URL: http://www.anakeen.com/
Packager: Yannick Le Briquer <yannick.lebriquer@anakeen.com>
BuildArchitectures: noarch
BuildRoot: %{_tmppath}/%{name}-%{version}-root-%(id -u -n)
Conflicts: AUTHENT USERS CORE APPMNG ACCESS libwhat libjs
#BuildRequires: docbook-dtd41-sgml
#BuildRequires: docbook-utils
BuildRequires: apache-devel
Requires: php >= 4.2
%if %{_apache2}
Requires: apache >= 2.0
%else
Requires: apache < 2.0
%endif
Requires: postgresql >= 7.2
Requires: postgresql-module-plpgsql
Requires: php-pgsql
Requires: php-gettext
Requires: php-pcre
Requires: php-cgi
Requires: php-mhash
Requires: php-ncurses
Requires: apache-mod_auth
Requires: apache-mod_auth_pam 
Requires: apache-mod_dir
Requires: apache-mod_expires
Requires: pam_what >= 0.4.0
Requires: ankpsql-tools
Requires: gettext
Requires: gettext-devel > 0.11
Requires: php-pear-Crypt_CHAP
Requires: binutils

Prereq: apache
Prereq: grep
Prereq: SysVinit
Conflicts: FREEDOM-USERCARD < 0.4.0
Conflicts: libuser < 2.2.3

%description
The WHAT application toolkit gives common interface element to develop web applications


%prep
%setup -q -n %{name}-%{version}

%build

%install
autoconf
./configure --with-pubrule=`pwd`
make -i pubdir=$RPM_BUILD_ROOT%{destdir} 
install -d $RPM_BUILD_ROOT/etc/httpd/httpd.conf
install $RPM_BUILD_ROOT/%{destdir}/apache.conf $RPM_BUILD_ROOT/etc/httpd/httpd.conf/71_mod_what.conf

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%post

if [ "$1" = 1 ] ; then
%if ! %{_apache2}
  # Add apache options for what
  if [ -f /etc/httpd/conf/httpd.conf ] ; then
     echo "Include %{destdir}/apache.conf" >>/etc/httpd/conf/httpd.conf
  else
     echo "Include %{destdir}/apache.conf" >>/etc/httpd/httpd.conf
  fi  
%endif

  # Restart Apache if running
if [ -f /var/lock/subsys/httpd ]; then
	/etc/rc.d/init.d/httpd restart 1>&2
fi

else   

  # just update
  echo
fi
for fbash in  ~/.bashrc ~/.bash_profile; do
    ll=0
    if [ -f $fbash ] ; then
	ll=`grep "winitrc" $fbash | wc -l`
    fi    
    if [ $ll -eq 0 ]; then 
	echo ". %{destdir}/winitrc" >>  $fbash
    fi
done

%{destdir}/wstop


%preun


%postun

  if [ "$1" = 0 ] ; then 

    if [ -f /etc/httpd/conf/httpd.conf ] ; then
       grep -v "Include %{destdir}/apache.conf" /etc/httpd/conf/httpd.conf >/etc/httpd/conf/httpd.conf.tmp
       mv /etc/httpd/conf/httpd.conf.tmp /etc/httpd/conf/httpd.conf
    else if [ -f /etc/httpd/httpd.conf ] ; then
       grep -v "Include %{destdir}/apache.conf" /etc/httpd/httpd.conf >/etc/httpd/httpd.conf.tmp
       mv /etc/httpd/httpd.conf.tmp /etc/httpd/httpd.conf
       fi
    fi
    for fbash in  ~/.bashrc ~/.bash_profile; do
	ll=0
	if [ -f $fbash ] ; then
	    grep -v "winitrc" $fbash > $fbash.tmp
	    mv $fbash.tmp $fbash
	fi    
    done

    # Restart Apache if running
    if [ -f /var/lock/subsys/httpd ]; then
	/etc/rc.d/init.d/httpd restart 1>&2
    fi
  fi


%files
%defattr(-,root,root)
%dir %{destdir}
%doc ChangeLog
%dir %{destdir}/ACCESS
%dir %{destdir}/API
%dir %{destdir}/APPMNG
%dir %{destdir}/AUTHENT
%dir %{destdir}/STYLE
%dir %{destdir}/USERS
%dir %{destdir}/CORE
%dir %{destdir}/WHAT
%dir %{destdir}/expire

%{destdir}/ACCESS/*
%{destdir}/API/*
%{destdir}/APPMNG/*
%{destdir}/AUTHENT/*
%{destdir}/STYLE/*
%{destdir}/USERS/*
%{destdir}/CORE/*
%{destdir}/WHAT/*
%{destdir}/expire/*

%{destdir}/apache.conf
%{destdir}/guest.php
%{destdir}/index.php
%{destdir}/authent.php
%{destdir}/locale
%{destdir}/wcheck
%{destdir}/whattext
%{destdir}/wsh.php
%{destdir}/wstop
%{destdir}/wstart
%{destdir}/log.sh 
%{destdir}/apachev.conf.in
%{destdir}/apachevi.conf.in
%{destdir}/httpd.pam.in
%{destdir}/wchoose.php
%{destdir}/wdbcreate
%{destdir}/winitrc
%{destdir}/wvirtual.php

%config(noreplace) %{destdir}/dbaccess.php
%config(noreplace) /etc/pam.d/httpd
%config(noreplace) /etc/pam.d/httpdwa
/etc/cron.daily/*
%if %{_apache2}
%attr(640,root,root) %config(noreplace) %verify(not size mtime md5) /etc/httpd/httpd.conf/*_mod_*.conf
%endif

%changelog
* Tue Oct 30 2000 Yannick Le Briquer <yannick.lebriquer@anakeen.com>
- Build first RPM

