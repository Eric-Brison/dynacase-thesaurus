#! /:/bin/rpm
#
#  File: libwhat.spec
#  $Id: freedom-core.spec.in,v 1.10 2008/06/27 12:28:50 eric Exp $
#
#  This is the SPEC file for the What CORE
#  Anakeen What Application
# Conditional build
#  _with_cerbere2       - make rpm for cerbere 2.0
#

%define destdir @prefix@
%define apacheconfdir @APACHECONFDIR@
%define cerbere		%(rpm -q --queryformat '%{VENDOR}' rpm |grep -q 'none' && echo 1 || echo 0)
%define pld		%(rpm -q --queryformat '%{VENDOR}' rpm |grep -q 'PLD' && echo 1 || echo 0)
%define redhat	        %(rpm -q --queryformat '%{VENDOR}' rpm | grep -q -e 'Red Hat, Inc.' -e "Fedora"  && echo 1 || echo 0)
	
%{?ncerbere:%define cerbere 1}
%{?ncerbere:%define redhat 0}
%{?ncerbere:%define pld 0}
%{?nredhat:%define cerbere 0}
%{?nredhat:%define redhat 1}
%{?nredhat:%define pld 0}
%{?npld:%define cerbere 0}
%{?npld:%define redhat 0}
%{?npld:%define pld 1}

%if %{cerbere}
  %define destdir /home/httpd/what
  %define httpuser http
  %define apacheconfdir /etc/httpd/httpd.conf
  %define releasepostfix %(echo)
%else
  %if %{pld}
    %define destdir /usr/share/what
    %define httpuser http
    %define apacheconfdir /etc/webapps/what
    %define releasepostfix cb
   %else
      %if %{redhat}
        %define destdir /usr/share/what
        %define httpuser apache
        %define apacheconfdir /etc/httpd/conf.d
        %define releasepostfix fc%(cat /etc/fedora-release | sed -e 's/.* release \\([[:digit:]]\\+\\) .*/\\1/')
      %else        
        %define destdir /usr/share/what
        %define httpuser apache
        %define apacheconfdir /etc/httpd/conf.d
        %define releasepostfix unk
      %endif
  %endif
%endif

%{?ndestdir:%define destdir %{ndestdir}}
%{?nhttpuser:%define httpuser %{nhttpuser}}
%{?rpost:%define releasepostfix %{rpost}}

Summary: What Hosting Application Toolkit for freedom ECM
Name: @PACKAGE@
Version: @VERSION@
Release: @RELEASE@%{releasepostfix}
License: GPL
Group: Applications/Web
Source: ftp://ftp.souillac.anakeen.com/pub/anakeen/%{name}-%{version}.tar.gz
# post-2.2.0 fix (can go away with next release):
Vendor: Anakeen           
URL: http://www.anakeen.com/
Packager: Yannick Le Briquer <yannick.lebriquer@anakeen.com>
BuildArchitectures: noarch
BuildRoot: %{_tmppath}/%{name}-%{version}-root-%(id -u -n)
Conflicts: AUTHENT USERS CORE APPMNG ACCESS libwhat
Conflicts: MAIL < 0.5.1
Obsoletes:	WHAT
Provides:	WHAT = @VERSION@

#BuildRequires: docbook-dtd41-sgml
#BuildRequires: docbook-utils
%if %{cerbere} || %{pld}
#BuildRequires: apache-devel
%endif
%if %{cerbere} || %{pld}
Requires: apache >= 2.0
Requires: php-common >= 5.0
%else
Requires: httpd >= 2.0
Requires: php >= 5.0
%endif
Requires: postgresql >= 7.2
%if %{cerbere} || %{pld}
Requires: postgresql-module-plpgsql
%else
#Requires: postgresql-pl # is is in the kernel now
%endif
Requires: php-pgsql
%if %{cerbere} || %{pld}
Requires: php-gettext
Requires: php-cgi
Requires: php-mhash
Requires: php-mcrypt
Requires: apache-mod_php
%endif
Requires: php-ncurses
%if %{cerbere} || %{pld}
Requires: apache-mod_dir
Requires: apache-mod_expires
%endif


%if %{cerbere}
Requires: apache-mod_auth
Requires: apache-mod_auth_pam 
%else
Requires: apache-mod_authn_pam 
%endif
Requires: pam_what >= 0.4.0
Requires: ankpsql-tools
Requires: gettext
Requires: which
BuildRequires: gettext
%if %{cerbere} || %{pld}
%{!?nobuildrequire:BuildRequires: gettext-devel > 0.11}
Requires: php-pear-PEAR
Requires: php-gd
%endif
Requires: php-pear
%if  %{pld}
Requires: apache-mod_php
%endif
%if %{cerbere} || %{pld}
Prereq: apache
Requires: php-pear-Crypt_CHAP
%else
Prereq: httpd
Requires: php-pear-Crypt-CHAP
%endif
%if %{pld}
Prereq: htpasswd-apache
Prereq: webapps
%endif
Prereq: grep
Prereq: SysVinit
Prereq: sudo
Requires: FREEDOM-USERCARD > 0.4.0
%if %{cerbere} || %{pld}
Conflicts: libuser < 2.2.3
%endif

%description
The WHAT application toolkit gives common interface element to develop web applications


%prep
%setup -q -n %{name}-%{version}

%build

%install
autoconf
./configure --with-pubrule=`pwd` \
	    --with-httpuser=%{httpuser} \
	    --with-apacheconfdir=%{apacheconfdir} \
	    --prefix=%{destdir}
make -i pubdir=$RPM_BUILD_ROOT%{destdir} 
install -d $RPM_BUILD_ROOT%{apacheconfdir}

%if %{cerbere}
install $RPM_BUILD_ROOT/%{destdir}/apache.conf $RPM_BUILD_ROOT/%{apacheconfdir}/71_mod_what.conf
%else
  %if %{pld} 
    install $RPM_BUILD_ROOT/%{destdir}/apache.conf $RPM_BUILD_ROOT/%{apacheconfdir}/httpd.conf
  %else
    install $RPM_BUILD_ROOT/%{destdir}/apache.conf $RPM_BUILD_ROOT/%{apacheconfdir}/71_mod_what.conf
  %endif
%endif

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%post

%if %{pld} 
   if [ -x /usr/sbin/webapp ]; then
	/usr/sbin/webapp register httpd what
   fi
%endif


if [ "$1" = 1 ] ; then
 if [ -f %{destdir}/index.php ]; then
    /bin/rm %{destdir}/index.php
 fi
  # Restart Apache if running
  if [ -f /var/lock/subsys/httpd ]; then
	/etc/rc.d/init.d/httpd restart 1>&2
  fi
  if [ ! -f %{destdir}/admin/.htpasswd ]; then
    htpasswd -cb %{destdir}/admin/.htpasswd admin admin
  fi
else   

  # just update
  
  chown -R %{httpuser}: %{destdir} 
  if [ ! -f %{destdir}/admin/.htpasswd ]; then
	htpasswd -cb %{destdir}/admin/.htpasswd admin admin
  fi
  
fi
sed -i '/shttpd/d' /etc/sudoers
echo "%{httpuser} ALL=NOPASSWD:%{destdir}/admin/shttpd" >> /etc/sudoers


%{destdir}/wstop


%preun


%postun

  if [ "$1" = 0 ] ; then 

    for fbash in  ~/.bashrc ~/.bash_profile; do
	ll=0
	if [ -f $fbash ] ; then
	    grep -v "winitrc" $fbash > $fbash.tmp
	    mv $fbash.tmp $fbash
	fi    
    done
    sed -i '/shttpd/d' /etc/sudoers

    # Restart Apache if running
    if [ -f /var/lock/subsys/httpd ]; then
	/etc/rc.d/init.d/httpd restart 1>&2
    fi

%if %{pld} 
    if [ -x /usr/sbin/webapp ]; then
	/usr/sbin/webapp unregister httpd what
    fi
%endif
  fi


%files
%defattr(-,%{httpuser},%{httpuser})
%dir %{destdir}
%doc ChangeLog
%dir %{destdir}/ACCESS
%dir %{destdir}/API
%dir %{destdir}/APPMNG
%dir %{destdir}/AUTHENT
%dir %{destdir}/STYLE
%dir %{destdir}/USERS
%dir %{destdir}/CORE
%dir %{destdir}/WHAT
%dir %{destdir}/expire
%dir %{destdir}/context/default/FDLGEN
%{destdir}/FDLGEN/default

%{destdir}/ACCESS/*
%{destdir}/API/*
%{destdir}/APPMNG/*
%{destdir}/AUTHENT/*
%{destdir}/STYLE/*
%{destdir}/USERS/*
%{destdir}/CORE/*
%{destdir}/WHAT/*
%{destdir}/expire/*
%{destdir}/admin/*

%{destdir}/apache.conf
%{destdir}/guest.php
%{destdir}/authent.php
%{destdir}/locale
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wcheck
%attr(755,%{httpuser},%{httpuser}) %{destdir}/whattext
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wsh.php
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wstop
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wstart
%{destdir}/log.sh 
%{destdir}/apachev.conf.in
%{destdir}/apachevi.conf.in
%{destdir}/httpd.pam.in
%{destdir}/httpdwa.pam.in
%{destdir}/wchoose.php
%{destdir}/resizeimg.php
%attr(755,%{httpuser},%{httpuser}) %{destdir}/wdbcreate
%{destdir}/winitrc
%{destdir}/wvirtual.php
%{destdir}/libutil.sh
%{destdir}/context/default/dbaccess.php.sample
# %config(noreplace) %{destdir}/context/default/dbaccess.php

%{destdir}/index.php.q
%{destdir}/index.php

%attr(755,%{httpuser},%{httpuser}) %{destdir}/wcontrol
%{destdir}/wcontrol.xml

%defattr(-,root,root)
%dir /etc
%dir /etc/pam.d
%dir /etc/cron.daily
%dir /%{apacheconfdir}
# %config(noreplace) /etc/pam.d/httpd
# %config(noreplace) /etc/pam.d/httpdwa
/etc/pam.d/httpd.freedom.sample
/etc/pam.d/httpdwa.freedom.sample
%config /etc/freedom.conf
/etc/cron.daily/*
%if %{cerbere}
  %attr(640,root,root) %config(noreplace) %verify(not size mtime md5) /%{apacheconfdir}/*_mod_*.conf
%else
  %if %{pld}
    %attr(640,root,root) %config(noreplace) %verify(not size mtime md5) /%{apacheconfdir}/httpd.conf
  %else
    %attr(640,root,root) %config(noreplace) %verify(not size mtime md5) /%{apacheconfdir}/*_mod_*.conf
  %endif
%endif

%changelog
* Tue Oct 30 2000 Yannick Le Briquer <yannick.lebriquer@anakeen.com>
- Build first RPM

