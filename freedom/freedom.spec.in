#! /bin/rpm
#
#  File: libwhat.spec
#  $Id: freedom.spec.in,v 1.4 2008/05/06 13:11:06 marc Exp $
#
#  This is the SPEC file for the What Users Module
#  Anakeen What Application
#

%define cerbere         %(rpm -q --queryformat '%{VENDOR}' rpm |grep -q 'none' && echo 1 || echo 0)
%define pld		%(rpm -q --queryformat '%{VENDOR}' rpm |grep -q 'PLD' && echo 1 || echo 0)
%define redhat	        %(rpm -q --queryformat '%{VENDOR}' rpm | grep -q -e 'Red Hat, Inc.' -e "Fedora"  && echo 1 || echo 0)
%{?ncerbere:%define cerbere 1}
%{?ncerbere:%define redhat 0}
%{?ncerbere:%define pld 0}
%{?nredhat:%define cerbere 0}
%{?nredhat:%define redhat 1}
%{?nredhat:%define pld 0}
%{?npld:%define cerbere 0}
%{?npld:%define redhat 0}
%{?npld:%define pld 1}

%if %{cerbere}
  %define destdir /home/httpd/what
  %define httpuser http
  %define apacheconfdir /etc/httpd/httpd.conf
  %define releasepostfix %(echo)
  %define ldapuser slapd
%else
  %if %{pld}
    %define destdir /usr/share/what
    %define httpuser http
    %define apacheconfdir /etc/webapps/what
    %define releasepostfix cb
    %define ldapuser slapd
   %else
      %if %{redhat}
        %define destdir /usr/share/what
        %define httpuser apache
        %define apacheconfdir /etc/httpd/conf.d
        %define releasepostfix fc%(cat /etc/fedora-release | sed -e 's/.* release \\([[:digit:]]\\+\\) .*/\\1/')
        %define ldapuser ldap
      %else        
        %define destdir /usr/share/what
        %define httpuser apache
        %define apacheconfdir /etc/httpd/conf.d
        %define releasepostfix unk
        %define ldapuser ldap
      %endif
  %endif
%endif


%{?ndestdir:%define destdir %{ndestdir}}
%{?nhttpuser:%define httpuser %{nhttpuser}}
%{?rpost:%define releasepostfix %{rpost}}

Summary: The freedom ECM  Management Module
Name: @PACKAGE@
Version: @VERSION@
License: GPL
Release: @RELEASE@%{releasepostfix}
Group: Applications/Web
Source: ftp://ftp.souillac.anakeen.com/pub/anakeen/%{name}-%{version}.tar.gz
# post-2.2.0 fix (can go away with next release):
Vendor: Anakeen           
URL: http://www.anakeen.com/
Packager: Yannick Le Briquer <yannick.lebriquer@anakeen.com>
BuildArchitectures: noarch
BuildRoot: %{_tmppath}/%{name}-%{version}-root-%(id -u -n)
PreReq: @PACKAGE@-lib = %{version}
Requires: @PACKAGE@-usercard
Obsoletes:	FREEDOM
Provides:	FREEDOM = @VERSION@
%description
The FREEDOM (Free Document Object Model) module is use to manage document in intranet


%package lib
Summary: The freedom ECM libraries functions
Group: Applications/Web
Requires: php-gd
Requires: FCKeditor
Requires: php-calendar
Requires: postgresql >= 8.0
Requires: html2ps
Requires: ghostscript
Requires: aspell-fr
Requires: aspell-en
%if %{cerbere} || %{pld}
Requires: ghostscript-fonts-std
Requires: php-pspell
Requires: php-sysvsem
Requires: php-dom
Requires: php-xsl
Requires: php-pear-Net_SMTP
Requires: php-pear-Mail_Mime
%else
Requires: ghostscript-fonts
Requires: php-pear-Net-SMTP
Requires: php-pear-Mail-Mime
%endif
Requires: netpbm
Requires: netpbm-progs
Requires: php-xml
Requires: tar
Requires: zip
Requires: unzip
Requires: bzip2
Requires: FREEDOM-COMMON
PreReq: vixie-cron
PreReq: freedom-core >= 2.11.0
Prereq: freedom-vault >= 3.5.0
Prereq: gettext
%if %{cerbere} || %{pld}
Prereq: php-cgi 
Prereq: gettext-devel
%else
Prereq: php
%endif
Conflicts: ROAMING < 0.0.5
Conflicts: AFFMON < 0.2.5
Obsoletes:	FREEDOM-LIB
Provides:	FREEDOM-LIB = @VERSION@

%description lib
The FREEDOM LIBS is necessary to use functionnality of the FREEDOM module

%package usercard
Summary: The FREEDOM users management
Group: Applications/Web
Requires: php-ldap
%if %{cerbere} || %{pld}
Requires: openldap-servers
Requires: openldap-backend-bdb
Requires: postgresql-module-tsearch2
%else
Requires: openldap-servers
Requires: postgresql-contrib
%endif
Requires: graphviz
PreReq: freedom-core
PreReq: freedom-lib = %{version}
PreReq: freedom = %{version}
Obsoletes:	FREEDOM-USERCARD
Provides:	FREEDOM-USERCARD = @VERSION@

%description usercard
The freedom ECM user card module allow to view & edit user card and to insert them in a LDAP server



%prep
%setup -q -n %{name}-%{version}

%build

%install
autoconf
./configure  --with-pubrule=`pwd` \
	     --with-httpuser=%{httpuser} \
	     --prefix=%{destdir}
make  pubdir=$RPM_BUILD_ROOT%{destdir}
ln -s editbodycard.xml $RPM_BUILD_ROOT/%{destdir}/FDL/Layout/editoptcard.xml
ln -s viewbodycard.xml $RPM_BUILD_ROOT/%{destdir}/FDL/Layout/viewoptcard.xml
[ ! -d $RPM_BUILD_ROOT/%{destdir}/htmlarea/htmlarea ] && mkdir $RPM_BUILD_ROOT/%{destdir}/htmlarea/htmlarea
cd $RPM_BUILD_ROOT/%{destdir}/htmlarea/htmlarea
ln -sf ../images .
ln -sf ../popups .
cd - > /dev/null
cd $RPM_BUILD_ROOT/%{destdir}/EXTERNALS
ln -s ../FDL/fdlsearches.php .
cd - > /dev/null
install -d $RPM_BUILD_ROOT/var/freedom 

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%post 
%{destdir}/wstop

%preun


%post usercard
%{destdir}/wstop

%preun usercard




%post lib
%{destdir}/wstop


%preun lib


%files
%defattr(-,%{httpuser},%{httpuser})
%dir %{destdir}/@APPNAME@
%{destdir}/@APPNAME@/*
%dir %{destdir}/ONEFAM
%{destdir}/ONEFAM/*
%dir %{destdir}/FGSEARCH
%{destdir}/FGSEARCH/*
%dir %{destdir}/CONTRIB
%{destdir}/CONTRIB/*

%files usercard
%defattr(-,%{httpuser},%{httpuser})
%dir %{destdir}/USERCARD
%dir %{destdir}/FUSERS
%{destdir}/USERCARD/*
%{destdir}/FUSERS/*
%attr(600,%{ldapuser},%{ldapuser}) %config(noreplace) /etc/openldap/slapd_anakeen.conf


%files lib
%defattr(-,%{httpuser},%{httpuser})
%dir %{destdir}/FDLGEN
%dir %{destdir}/FDL
%dir %{destdir}/GENERIC
%dir %{destdir}/img-cache
%dir %{destdir}/htmlarea
%dir %{destdir}/fckeditor
%dir %{destdir}/jscalendar
%dir %{destdir}/jsXMLParser
%dir %{destdir}/moz-searchplugin
%dir %{destdir}/mcal
%{destdir}/FDL/*
%{destdir}/GENERIC/*
%{destdir}/locale/*
%{destdir}/API/*
%dir %{destdir}/EXTERNALS
%{destdir}/EXTERNALS/*
%{destdir}/htmlarea/*
%{destdir}/fckeditor/*
%{destdir}/jscalendar/*
%{destdir}/jsXMLParser/*
%{destdir}/moz-searchplugin/*
%{destdir}/mcal/*
/var/freedom


%attr(700,root,root) /etc/cron.d/FREEDOM.cron

%changelog
* Tue Oct 30 2000 Yannick Le Briquer <yannick.lebriquer@anakeen.com>
- Build first RPM

