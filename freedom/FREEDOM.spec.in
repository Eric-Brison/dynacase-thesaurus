#! /bin/rpm
#
#  File: libwhat.spec
#  $Id: FREEDOM.spec.in,v 1.20 2002/05/27 14:54:14 eric Exp $
#
#  This is the SPEC file for the What Users Module
#  Anakeen What Application
#

%define apachedir /etc/httpd
%define destdir /home/httpd/what

Summary: The What Users Management Module
Name: @PACKAGE@
Version: @VERSION@
Release: @RELEASE@
Copyright: GPL
Group: Applications/Web
Source: ftp://ftp.souillac.anakeen.com/pub/anakeen/%{name}-%{version}.tar.gz
# post-2.2.0 fix (can go away with next release):
Vendor: Anakeen           
URL: http://www.anakeen.com/
Packager: Yannick Le Briquer <yannick.lebriquer@anakeen.com>
BuildArchitectures: noarch
BuildRoot: /tmp/anakeen-root
Requires: php >= 4.0.5
Requires: postgresql >= 7.2
Requires: php-pgsql >= 4.0.2
PreReq: WHAT >= 0.0.9
PreReq: @PACKAGE@-LIB = %{version}
Prereq: VAULT
Prereq: php-shell >= 4.0.2
Prereq: gettext

%description
The FREEDOM (Free Document Object Model) module is use to manage document in intranet


%package LIB
Summary: libraries of FREEDOM module
Group: Applications/Web
Version: @VERSION@
Release: @RELEASE@
PreReq: WHAT

%description LIB
The FREEDOM LIBS is necessary to use functionnality of the FREEDOM module

%package USERCARD
Summary: user card management
Group: Applications/Web
Version: @VERSION@
Release: @RELEASE@
PreReq: WHAT
PreReq: @PACKAGE@-LIB = %{version}

%description USERCARD
The user card module allow to view & edit user card and to insert them in a LDAP server

%package INCIDENT
Summary: incident management
Group: Applications/Web
Version: @VERSION@
Release: @RELEASE@
PreReq: WHAT
PreReq: @PACKAGE@-LIB = %{version}

%description INCIDENT
The incident module allow to edit problems for an hot-line

%prep
%setup -q -n %{name}-%{version}

%build

%install
autoconf
./configure  --with-pubrule=`pwd`
make pubdir=$RPM_BUILD_ROOT%{destdir}

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%post 
if [ "$1" = 1 ] ; then
  echo "Initiate Database elements"  
  %{destdir}/wsh.php --api=appadmin  --appname=@PACKAGE@ 
else
  echo "Update Database elements"
  %{destdir}/wsh.php --api=appadmin --method=update --appname=@PACKAGE@
fi
/bin/ln -sf %{destdir}/FDL/include.php %{destdir}/FREEDOM/include.php

%preun
if [ "$1" = 0 ] ; then
  echo "Remove Database elements"
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=@PACKAGE@
fi

%post USERCARD
if [ "$1" = 1 ] ; then
  echo "Initiate Database elements"  
  %{destdir}/wsh.php --api=appadmin  --appname=USERCARD
  %{destdir}/wsh.php --app=USERCARD --action=USERCARD_INIT 
else
  echo "Update Database elements"
  %{destdir}/wsh.php --api=appadmin --method=update --appname=USERCARD
fi
ln -sf %{destdir}/FDL/include.php %{destdir}/USERCARD/include.php

%preun USERCARD
if [ "$1" = 0 ] ; then
  echo "Remove Database elements"
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=USERCARD
fi

%post INCIDENT
if [ "$1" = 1 ] ; then
  echo "Initiate Database elements"  
  %{destdir}/wsh.php --api=appadmin  --appname=INCIDENT
  %{destdir}/wsh.php --app=INCIDENT --action=INCIDENT_INIT 
  %{destdir}/wsh.php --api=appadmin  --appname=SITE
  %{destdir}/wsh.php --api=appadmin  --appname=PRODUCT
  %{destdir}/wsh.php --api=appadmin  --appname=CONTRACT
else
  echo "Update Database elements"
  %{destdir}/wsh.php --api=appadmin --method=update --appname=INCIDENT
  %{destdir}/wsh.php --api=appadmin --method=update --appname=SITE
  %{destdir}/wsh.php --api=appadmin --method=update --appname=PRODUCT
  %{destdir}/wsh.php --api=appadmin --method=update --appname=CONTRACT
fi
ln -sf %{destdir}/FDL/include.php %{destdir}/INCIDENT/include.php
ln -sf %{destdir}/FDL/include.php %{destdir}/SITE/include.php
ln -sf %{destdir}/FDL/include.php %{destdir}/PRODUCT/include.php
ln -sf %{destdir}/FDL/include.php %{destdir}/CONTRACT/include.php

%preun INCIDENT
if [ "$1" = 0 ] ; then
  echo "Remove Database elements"
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=INCIDENT
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=SITE
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=PRODUCT
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=CONTRACT
fi

%post LIB
if [ "$1" = 1 ] ; then
  echo "Create @DBNAME@ database"
  su - postgres -c "createdb @DBNAME@" 2>&1 >>/dev/null
  echo "Create @DBUSER@ database  user"
  su - postgres -c "createuser -d -a @DBUSER@" 2>&1 >>/dev/null
  echo "Add plpgsql language"
  su - postgres -c "createlang --dbname=freedom --pglib=/usr/lib/pgsql plpgsql" 2>&1 >>/dev/null
  echo "Initiate Database elements"  
  %{destdir}/wsh.php --api=appadmin  --appname=FDL
  %{destdir}/wsh.php --app=FDL --action=FREEDOM_INIT  
  %{destdir}/wsh.php --api=appadmin  --appname=GENERIC
else
  echo "Update Database elements"
  %{destdir}/wsh.php --api=appadmin --method=update --appname=@PACKAGELIB@
  %{destdir}/wsh.php --api=appadmin --method=update --appname=GENERIC
fi
ln -sf %{destdir}/FDL/include.php %{destdir}/GENERIC/include.php
#share postgres group table
%{destdir}/FDL/FDL_init.sh
# merge @PACKAGE@ translation for i18n
for lang in en fr ; do
    pushd /home/httpd/what/locale/$lang/LC_MESSAGES >/dev/null
    msgunfmt --force-po @PACKAGE@.mo -o @PACKAGE@.po
    msgunfmt --force-po what.mo -o what.po
    msgfmt what.po @PACKAGE@.po -o what.mo
    rm -f *.po
    popd >/dev/null
done

%preun LIB
if [ "$1" = 0 ] ; then
  echo "Remove Database elements"
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=@PACKAGELIB@
  %{destdir}/wsh.php --api=appadmin --method=delete --appname=GENERIC
fi

%files
%defattr(-,root,root)
%dir %{destdir}/%{name}
%{destdir}/%{name}/*

%files USERCARD
%defattr(-,root,root)
%dir %{destdir}/USERCARD
%{destdir}/USERCARD/*


%files INCIDENT
%defattr(-,root,root)
%dir %{destdir}/INCIDENT
%dir %{destdir}/SITE
%dir %{destdir}/PRODUCT
%dir %{destdir}/CONTRACT
%dir %{destdir}/EXTERNALS
%{destdir}/INCIDENT/*
%{destdir}/SITE/*
%{destdir}/PRODUCT/*
%{destdir}/CONTRACT/*
%{destdir}/EXTERNALS/*

%files LIB
%defattr(-,root,root)
%dir %{destdir}/FDL
%dir %{destdir}/GENERIC
%{destdir}/FDL/*
%{destdir}/GENERIC/*
%{destdir}/locale/*
%{destdir}/API/*
%dir %{destdir}/EXTERNALS
%{destdir}/EXTERNALS/*
%dir /etc/cron.daily
/etc/cron.daily/*


%changelog
* Tue Oct 30 2000 Yannick Le Briquer <yannick.lebriquer@anakeen.com>
- Build first RPM

