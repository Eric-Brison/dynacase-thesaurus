#!/bin/bash

 

pubdir="/home/httpd/what";

/usr/bin/php -q $pubdir/API/updateclass.php --dbname=freedom --appc=FDL --class=DocAttr


    

psql freedom anakeen -f $pubdir/FDL/FDL_migr_0.2.0.sql
/usr/bin/php -q $pubdir/API/updateclass.php --dbname=freedom --appc=FDL --class=Doc

/usr/bin/php -q $pubdir/API/updateclass.php --dbname=freedom --appc=FDL --class=DocFam
/usr/bin/php -q $pubdir/API/updateclass.php --dbname=freedom --appc=FDL --class=QueryDir


psql freedom anakeen -f $pubdir/FDL/fdl.sql

# creation des class PHP

echo "insert into docfam (id, owner, title, revision, initid, fromid, doctype, locked, icon, lmodify, profid, usefor, revdate, comment, classname, state, wid)  select id, owner, title, revision, initid, fromid, doctype, locked, icon, lmodify, profid, usefor, revdate, comment, classname, state, wid from only doc where  doctype='C';delete from only doc where  doctype='C';" | psql freedom anakeen
$pubdir/wsh.php --api=fdl_adoc 

$pubdir/wsh.php --api=migr_sql2.0 --table=yes | psql freedom anakeen

psql freedom anakeen -f $pubdir/FDL/FDL_migr_0.2.0-1.sql




# creation des class PHP (2ème passe)
$pubdir/wsh.php --api=fdl_adoc 
# creation des fonctions de trigger
#$pubdir/wsh.php --api=fdl_trigger  | psql freedom anakeen
# activation des triggers
#$pubdir/wsh.php --api=fdl_trigger --trigger=yes | psql freedom anakeen

#migration des permissions
echo "update doc set profid=0  where id=profid and profid not in (select id_obj from operm);" | psql freedom anakeen
/usr/bin/php -q $pubdir/API/updateclass.php --dbname=freedom --appc=FDL --class=DocPerm
$pubdir/wsh.php --api=migr_sql2.0 --perm=yes 
echo "update doc set profid=-profid where profid > 0 and profid not in (select docid from docperm);" | psql freedom anakeen


echo "VACUUM FULL ANALYZE;" | psql freedom anakeen

psql anakeen anakeen -f $pubdir/FDL/FDL_migr_0.2.0-2.sql
