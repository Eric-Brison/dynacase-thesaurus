#!/bin/bash

pubdir="@prefix@";

if [ "$dbanakeen" = "" ]; then
    dbname="anakeen"
else
    dbname=$dbanakeen
fi
dbfreename=`$pubdir/wsh.php --api=get_param --param=FREEDOM_DB | sed -e 's/^.*dbname[[:space:]]*=[[:space:]]*\([[:alnum:]]*\).*$/\1/'`
if [ "$dbfreename" = "" ]; then
    dbfreename="freedom";
fi
echo $dbname $dbfreename

#------------------------------
#post installation
#------------------------------
if [ "$1" = "I" ] ; then

  echo "Create $dbfreename database"
  su - postgres -c "createdb --encoding LATIN1 $dbfreename" 2>&1 >>/dev/null
  
  if [ -f /usr/lib/pgsql/plpgsql.so ]; then
      su - postgres -c "createlang --dbname=$dbfreename --pglib=/usr/lib/pgsql plpgsql" 2>&1 >>/dev/null
  else
      su - postgres -c "createlang --dbname=$dbfreename --pglib=/usr/lib/postgresql plpgsql" 2>&1 >>/dev/null
  fi
  
  su - postgres -c "psql $dbfreename -f @prefix@/WHAT/getprivilege.sql"
  su - postgres -c "psql $dbfreename anakeen -f @prefix@/FDL/fdl.sql"
  /usr/bin/php -q $pubdir/API/updateclass.php --dbname=$dbfreename --appc=FDL --class=Doc
  /usr/bin/php -q $pubdir/API/updateclass.php --dbname=$dbfreename --appc=FDL --class=DocPerm
  /usr/bin/php -q $pubdir/API/updateclass.php --dbname=$dbfreename --appc=FDL --class=VGroup
  /usr/bin/php -q $pubdir/API/updateclass.php --dbname=$dbfreename  --class=Group
  #copy postgres group table
  $pubdir/wsh.php --api=freedom_groups

  #prepare VAULT directories
  mkdir -p /var/freedom
  chown @HTTPUSER@: /var/freedom

  DBFREENAME=`echo $dbfreename | tr [a-z] [A-Z]`
  if [ ! -f $pubdir/VAULT/$DBFREENAME.vault ]; then
    #cp $pubdir/FDL/FREEDOM.vault $pubdir/VAULT/FREEDOM.vault
    sed -e"s/fs1/$dbfreename/g" $pubdir/FDL/FREEDOM.vault > $pubdir/VAULT/$DBFREENAME.vault
  fi
  $pubdir/wsh.php --api=vault_init

#  $pubdir/wsh.php --app=FDL --action=FREEDOM_INIT  
 # psql $dbfreename anakeen -f $pubdir/API/freedom_clean.sql
fi
#------------------------------
#post update
#------------------------------
if [ "$1" = "U" ] ; then


  #copy postgres group table
  $pubdir/wsh.php --api=freedom_groups

  $pubdir/wsh.php --app=FDL --action=FREEDOM_INIT  

  su - postgres -c "psql $dbfree -f @prefix@/WHAT/getprivilege.sql"
  su - postgres -c "psql $dbfree -f @prefix@/FDL/fdl.sql"
  $pubdir/wsh.php --api=fdl_adoc
  $pubdir/wsh.php --api=fdl_trigger | psql $dbfree
  $pubdir/wsh.php --api=fdl_trigger --trigger=Y | psql $dbfree

fi
